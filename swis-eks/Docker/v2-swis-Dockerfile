#FROM node:alpine
FROM node:17.8-alpine
RUN apk add --update --no-cache curl py-pip make g++ nginx

RUN apk update
# adding it seperately
RUN apk add aws-cli

WORKDIR /var/lib/swis-api

COPY ./v2-swis-project /var/lib/swis-api
COPY ./Docker/mongodb.pem /var/lib/swis-api/ssl/mongodb.pem
COPY ./Docker/swis.env /var/lib/swis-api
COPY ./Docker/rootCA.pem /var/lib/swis-api/ssl/rootCA.pem

# nginx configuration
RUN mkdir /root/.ssh /root/.aws /var/lib/swis-api/sitemap/
ADD --chown=root ./Docker/nginx.conf /etc/nginx/nginx.conf
COPY --chown=root ./Docker/.aws /root/.aws/

# for enabling 15 mins cron
ADD --chown=root ./Docker/sitemapscript /etc/periodic/15min/sitemapscript
RUN chmod 755 /etc/periodic/15min/sitemapscript

# RUN chmod -R 755 /var/lib/swis-api
RUN chmod 644 /var/lib/swis-api/ssl/* /var/lib/swis-api/swis.env

RUN yarn install --production=true
RUN source swis.env && yarn build 

# need to check this line
#EXPOSE 8080

CMD nginx && crond && yarn start
